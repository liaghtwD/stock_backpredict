# 股票交易策略系统 - 完整文档

基于机器学习的双策略量化交易系统,包含中长期策略(GA优化+LSTM三分类)和短期策略(逻辑回归),提供市场周期分段回测分析。

---

## 📊 项目概述

本项目实现了两种互补的量化交易策略,并在不同市场环境下进行了全面测试:

### 策略架构
1. **中长期策略** (GA优化 + LSTM三分类)
   - 观察窗口: 60天历史数据
   - 预测周期: 未来20天走势
   - 模型: Conv1d + GRU + Attention三分类网络
   - 优化: 遗传算法(GA)针对14个行业分组优化参数
   
2. **短期策略** (逻辑回归)
   - 观察窗口: 5天历史数据
   - 预测周期: 预测次日走势
   - 模型: 88个股票独立训练的逻辑回归模型
   - 特征: 52个技术指标

3. **市场周期分析**
   - 根据牛市/熊市/震荡市对策略表现分段评估
   - 识别各周期对总收益的贡献度和风险特征

### 回测结果摘要 (2021-2025)

| 市场周期 | 策略类型 | 年化收益 | 最大回撤 | 夏普比率 | 胜率 | 股票覆盖 |
|---------|---------|---------|---------|----------|------|----------|
| **震荡市** (3.7年) | 中长期 | 4.09% | 5.78% | 0.71 | 50% | 74只(84%) |
| | 短期 | **5.57%** | 9.75% | 0.57 | **100%** | 87只(99%) |
| **牛市** (1年) | 中长期 | 0.76% | 1.96% | 0.39 | 50% | 75只(85%) |
| | 短期 | **8.80%** | 5.38% | **1.64** | 94% | 88只(100%) |

**核心结论**:
- ✅ **短期策略全面优于中长期**: 在震荡市和牛市中收益率、胜率、覆盖率均领先
- ⭐ **短期策略震荡市胜率100%**: 适合横盘整理行情
- 🚀 **短期策略牛市夏普1.64**: 风险调整收益优异
- ⚠️ **中长期策略牛市失效**: 0.76%年化远低于预期,可能因60天窗口反应滞后

---

## 🗂️ 项目结构

```
problem A/
├── README.md                          # 本文档
├── requirements.txt                   # Python依赖
│
├── stock_data/                        # 原始数据
│   └── stock_data/day/*.csv          # 日线OHLCV数据
│
├── features/                          # 特征工程
│   ├── {code}_features.csv           # 88只股票的特征文件(24个特征)
│   └── feature.py                     # 特征计算脚本
│
├── condition.csv                      # 市场周期标注(牛/熊/震荡)
│
├── model_long_term/                   # 中长期策略
│   ├── model_triclass.py             # LSTM三分类模型定义
│   ├── train_triclass_alpha.py       # 模型训练脚本
│   ├── model_triclass_alpha.pth      # 训练好的模型权重
│   ├── scaler_triclass.pkl           # 特征标准化器
│   │
│   ├── train_ga_params.py            # 遗传算法参数优化
│   ├── ga_best_params_2024.pkl       # GA优化后的参数(14个行业)
│   ├── run_full_ga_pipeline.py       # GA完整流程
│   │
│   ├── strategies/
│   │   └── triclass_core.py          # 策略核心逻辑
│   └── backtest_final.py             # 回测脚本
│
├── model_short/                       # 短期策略
│   ├── strategy_short_1.py           # 逻辑回归策略实现
│   └── train_lr_models.py            # 训练88个LR模型
│
├── lr_models/                         # 短期策略模型
│   └── {code}_lr_model.pkl           # 88个独立的LR模型
│
├── backtest_by_market_regime.py      # 市场周期分段回测主脚本
│
├── regime_analysis_results/           # 回测结果
│   ├── regime_analysis_longterm.csv  # 中长期策略各周期表现
│   ├── regime_analysis_shortterm.csv # 短期策略各周期表现
│   └── regime_comparison.csv         # 策略对比
│
└── 市场周期回测总结_2021-2025.md      # 详细分析报告
```

---

## 🚀 快速开始

### 1. 环境配置

```bash
# 安装依赖
pip install -r requirements.txt

# 主要依赖:
# - torch >= 2.0
# - pandas >= 1.5
# - numpy >= 1.24
# - scikit-learn >= 1.2
# - deap >= 1.4 (遗传算法)
```

### 2. 数据准备

```bash
# 1. 将股票日线数据放入 stock_data/stock_data/day/
# 格式: {code}.csv, 包含列 [day, open, high, low, close, volume, ...]

# 2. 生成特征文件
python feature.py

# 输出: features/{code}_features.csv (24个特征 + label_alpha标签)
```

### 3. 训练模型

#### 3.1 中长期策略

```bash
cd model_long_term

# Step 1: 训练基础LSTM三分类模型
python train_triclass_alpha.py
# 输出: model_triclass_alpha.pth, scaler_triclass.pkl

# Step 2: 使用遗传算法优化参数(按14个行业分组)
python run_full_ga_pipeline.py
# 输出: ga_best_params_2024.pkl
# 耗时: ~2-4小时(取决于CPU核心数)

# Step 3: 回测验证
python backtest_final.py
```

**GA优化说明**:
- 14个行业分组: 酒类、芯片、新能源、电池、汽车、光伏、家电、保险、券商、医药、银行、电力、消费、其他
- 优化参数: entry_up_threshold, entry_down_cap, entry_margin, add_up_threshold, exit_down_threshold
- 适应度函数: 夏普比率 × 收益率 - 惩罚项(回撤/交易次数)
- 种群大小: 50, 进化代数: 20, 突变率: 0.2

#### 3.2 短期策略

```bash
cd model_short

# 训练88个独立的逻辑回归模型
python train_lr_models.py
# 输出: ../lr_models/{code}_lr_model.pkl (88个文件)
```

### 4. 市场周期回测

```bash
# 运行完整的市场周期分段回测
python backtest_by_market_regime.py

# 输出:
# - regime_analysis_results/regime_analysis_longterm.csv
# - regime_analysis_results/regime_analysis_shortterm.csv  
# - regime_analysis_results/regime_comparison.csv
```

**回测配置**:
- 时间范围: 2021-01-01 至 2025-09-30 (4年9个月)
- 股票数量: 88只 (100%覆盖)
- 初始资金: 10,000,000元
- 市场周期: 基于condition.csv的牛/熊/震荡分类

---

## 📈 中长期策略详解

### 模型架构

```python
ConvGRUAttentionTriclass:
  ├── Conv1d(24→64, kernel=5)      # 捕捉3-5日局部波动
  ├── GRU(64→128, layers=2)        # 建模60日趋势
  ├── Attention(128→1)              # 自适应权重聚合
  └── Linear(128→3)                 # 三分类输出[down, neutral, up]
```

**设计动机**:
- **Conv1d**: 快速捕捉短期波动,减轻RNN对噪声的敏感
- **GRU**: 保留长期趋势,相比LSTM参数更少、收敛更稳
- **Attention**: 强化关键时间点,弱化横盘期冗余信号

### GA优化流程

```
1. 初始化种群(50个个体,每个包含5个阈值参数)
   ↓
2. 对每个个体进行回测评估
   - 计算收益率、最大回撤、夏普比率
   - 适应度 = 夏普 × 收益 - penalty(回撤, 交易次数)
   ↓
3. 选择、交叉、变异产生新一代
   ↓
4. 重复20代,保留最优个体
   ↓
5. 输出14个行业的最优参数组合
```

**优化参数示例** (高波动行业):
```python
{
    'entry_up_threshold': 0.65,    # 上涨概率>65%才买入
    'entry_down_cap': 0.24,        # 下跌概率<24%
    'entry_margin': 0.23,          # 上涨-下跌差>23%
    'add_up_threshold': 0.66,      # 加仓阈值
    'exit_down_threshold': 0.48    # 下跌概率>48%卖出
}
```

### 交易规则

**买入条件**:
1. 上涨概率 > entry_up_threshold
2. 下跌概率 < entry_down_cap
3. 上涨概率 - 下跌概率 > entry_margin
4. 大盘未破位(收盘价 > MA20)
5. 近期交易次数未超限

**卖出条件** (满足任一):
1. 亏损 > 6% (硬止损)
2. 盈利 > 5% 且从高点回撤 > 8% (移动止盈)
3. 下跌概率 > exit_down_threshold (模型看空)
4. 大盘破位 且 当前亏损 (风控)
5. 持仓 > 10天 且 盈亏在 [-2%, +2%] (时间止损)

---

## 📉 短期策略详解

### 模型特点

- **独立训练**: 每只股票训练一个独立的逻辑回归模型
- **特征数量**: 52个技术指标(动量、成交量、相对强弱等)
- **预测目标**: 次日是否上涨(二分类)

### 交易规则

```python
买入条件:
  - 预测概率 > 0.6 (模型看多)
  - 特征系数强度较高

持仓管理:
  - 止损: -3%
  - 止盈: +2.3%
  - 信号转弱: 预测概率 < 0.3 立即卖出

资金管理:
  - 每次买入使用全部可用资金
  - 不做杠杆,不做融资融券
```

### 优势与劣势

**优势**:
- ✅ 反应快速(5天窗口 vs 60天)
- ✅ 胜率极高(震荡市100%, 牛市94%)
- ✅ 股票覆盖完整(99-100%)
- ✅ 夏普比率优异(牛市1.64)

**劣势**:
- ⚠️ 震荡市回撤较大(9.75% vs 中长期5.78%)
- ⚠️ 交易频率低(平均每只股票1次/4年)

---

## 📊 市场周期回测结果

### 周期识别 (2021-2025)

```
震荡市: 2021-01-04 ~ 2024-09-26 (1362天, 78.7%)
  ├── 特征: 横盘整理,波动较小
  └── 市场表现: 整体平稳

牛市:   2024-09-27 ~ 2025-09-30 (369天, 21.3%)
  ├── 特征: 持续上涨,成交量放大
  └── 市场表现: 强势上扬

注: 此期间无熊市周期
```

### 震荡市表现 (2021-2024)

| 指标 | 中长期策略 | 短期策略 | 优势方 |
|------|-----------|---------|--------|
| 年化收益 | 4.09% | **5.57%** | 短期 +36% |
| 最大回撤 | **5.78%** | 9.75% | 中长期 -41% |
| 夏普比率 | **0.71** | 0.57 | 中长期 +25% |
| 胜率 | 50% | **100%** | 短期 |
| 交易次数 | 940 | 87 | - |
| 股票覆盖 | 74只(84%) | 87只(99%) | 短期 |

**分析**:
- 短期策略收益更高,胜率100%,适合震荡市
- 中长期策略回撤更小,夏普更优,风控更好
- 推荐: 震荡市优先短期策略(高胜率)

### 牛市表现 (2024-2025)

| 指标 | 中长期策略 | 短期策略 | 优势方 |
|------|-----------|---------|--------|
| 年化收益 | 0.76% | **8.80%** | 短期 +1058% |
| 最大回撤 | **1.96%** | 5.38% | 中长期 -64% |
| 夏普比率 | 0.39 | **1.64** | 短期 +321% |
| 胜率 | 50% | **94%** | 短期 |
| 交易次数 | 430 | 88 | - |
| 股票覆盖 | 75只(85%) | 88只(100%) | 短期 |

**分析**:
- ⚠️ 中长期策略严重失效(0.76%年化)
- ✅ 短期策略表现优异(8.80%年化, 1.64夏普)
- 推荐: 牛市明确选择短期策略

### 问题诊断: 中长期策略牛市失效

**可能原因**:
1. **60天观察窗口滞后**: 牛市初期信号反应慢
2. **GA参数过拟合**: 基于历史震荡市数据训练
3. **预测周期过长**: 20天预测期在快速上涨中不适用
4. **行业分类不足**: 14个分组可能对牛市行情覆盖不足

**改进建议**:
- 🔧 缩短观察窗口到30-40天
- 🔧 增加牛市数据重新训练GA
- 🔧 引入市场环境自适应参数
- 🔧 优化模型对趋势行情的敏感度

---

## 📁 关键文件说明

### 数据文件

| 文件 | 说明 | 格式 |
|------|------|------|
| `condition.csv` | 市场周期标注 | day, market, market_return, market_condition |
| `features/{code}_features.csv` | 股票特征 | day, close, volume, + 24个特征, label_alpha |
| `stock_data/day/{code}.csv` | 原始日线数据 | day, open, high, low, close, volume |

### 模型文件

| 文件 | 说明 | 大小 |
|------|------|------|
| `model_triclass_alpha.pth` | LSTM三分类模型权重 | 477.7 KB |
| `scaler_triclass.pkl` | 特征标准化器 | 1.0 KB |
| `ga_best_params_2024.pkl` | GA优化参数(14行业) | ~10 KB |
| `lr_models/{code}_lr_model.pkl` | 逻辑回归模型(88个) | ~2 KB/个 |

### 结果文件

| 文件 | 说明 |
|------|------|
| `regime_analysis_longterm.csv` | 中长期策略各周期表现 |
| `regime_analysis_shortterm.csv` | 短期策略各周期表现 |
| `regime_comparison.csv` | 策略对比汇总 |
| `市场周期回测总结_2021-2025.md` | 详细分析报告 |

---

## 🛠️ 高级用法

### 1. 自定义回测时间段

```python
# 编辑 backtest_by_market_regime.py
BACKTEST_START = '2021-01-01'  # 修改起始日期
BACKTEST_END = '2025-09-30'    # 修改结束日期
```

**注意**: 确保所有股票在该时间段都有数据

### 2. 调整GA优化参数

```python
# 编辑 model_long_term/train_ga_params.py

# 种群配置
POPULATION_SIZE = 50      # 增大提高质量但耗时更长
N_GENERATIONS = 20        # 增加代数可能找到更优解
MUTATION_RATE = 0.2       # 突变率,影响多样性

# 参数搜索空间
PARAM_BOUNDS = {
    'entry_up_threshold': (0.55, 0.75),
    'entry_down_cap': (0.20, 0.30),
    # ... 调整搜索范围
}
```

### 3. 添加新的行业分类

```python
# 编辑 backtest_by_market_regime.py

STOCK_CLASSIFICATION_MAP = {
    '000001': 'your_industry',  # 添加新股票
    # ...
}

# 然后运行GA优化
cd model_long_term
python run_full_ga_pipeline.py
```

### 4. 修改交易规则

```python
# 编辑 model_long_term/strategies/triclass_core.py

# 修改风控参数
self.hard_stop_loss = 0.06           # 硬止损 -6%
self.trailing_min_profit = 0.05      # 移动止盈触发 +5%
self.trailing_drawdown = 0.08        # 回撤阈值 -8%
self.time_stop_days = 10             # 时间止损 10天
```

---

## 🔍 常见问题

### Q1: 为什么中长期策略在牛市中表现差?

**A**: 主要原因是60天观察窗口在快速上涨行情中反应滞后。牛市初期信号出现时,模型仍基于前60天的震荡数据做判断,导致错过最佳买入时机。建议在牛市环境下使用短期策略。

### Q2: 如何选择使用哪个策略?

**A**: 
- **震荡市**: 优先短期策略(胜率100%),或中长期策略(低回撤)
- **牛市**: 明确选择短期策略(年化8.8% vs 0.76%)
- **熊市**: 未测试(2021-2025无熊市数据)

### Q3: GA优化需要多长时间?

**A**: 
- CPU: i7/Ryzen 7 → 约2-3小时
- CPU: i9/Ryzen 9 → 约1-2小时
- 可通过调整`POPULATION_SIZE`和`N_GENERATIONS`加速

### Q4: 为什么有些股票没有参与回测?

**A**: 
- 中长期策略需要至少80天历史数据(60天观察+20天预测)
- 短期策略需要至少6天历史数据
- 上市时间晚于回测起始时间的股票会被跳过

### Q5: 如何解释夏普比率?

**A**: 
- 夏普比率 = 年化收益 / 最大回撤
- > 1.0: 优秀(短期牛市1.64)
- 0.5-1.0: 良好(中长期震荡0.71)
- < 0.5: 一般

---

## 📚 技术栈

- **深度学习**: PyTorch 2.0+
- **数据处理**: Pandas, NumPy
- **机器学习**: Scikit-learn
- **遗传算法**: DEAP
- **可视化**: Matplotlib (可选)

---

## 📝 开发日志

### 2025-12
- ✅ 完成市场周期分段回测(2021-2025)
- ✅ 识别中长期策略牛市失效问题
- ✅ 确认短期策略全面优势
- ✅ 生成详细分析报告

### 2024-12
- ✅ 实现GA参数优化(14个行业分组)
- ✅ 训练LSTM三分类模型
- ✅ 训练88个逻辑回归模型
- ✅ 完成2024年回测验证

---

## 👥 贡献指南

欢迎提交Issue和Pull Request!

**改进方向**:
- 🔧 优化中长期策略的牛市表现
- 📊 增加可视化回测报告
- 🧪 添加更多技术指标
- 🌍 支持更多市场数据源

---

## 📄 许可证

MIT License

---

## 📞 联系方式

如有问题或建议,请通过Issue联系。

---

**最后更新**: 2025-12-07
